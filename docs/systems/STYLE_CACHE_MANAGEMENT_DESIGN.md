# Система управления кэшем стилей

## Обзор

Дизайн системы очистки и управления кэшем стилей игроков для оптимальной производительности и корректности данных.

## Текущая структура кэша

### Формат данных
```javascript
{
  "5860450": "sp",      // playerId: styleValue
  "5865756": "brazil",
  "1234567": "norm"
}
```

### Проблемы текущей системы
1. **Бесконечный рост**: Кэш накапливает данные без очистки
2. **Устаревшие данные**: Игроки могут быть проданы/куплены
3. **Межкомандные конфликты**: Стили игроков разных команд смешиваются
4. **Отсутствие метаданных**: Нет информации о времени создания записи

## Стратегии очистки кэша

### 1. **Автоматическая очистка по времени**

#### Идея: TTL (Time To Live)
```javascript
{
  "5860450": {
    style: "sp",
    timestamp: 1706995200000,  // Время установки
    ttl: 86400000             // 24 часа в мс
  }
}
```

**Преимущества:**
- Автоматическая очистка устаревших данных
- Гибкая настройка времени жизни
- Защита от бесконечного роста

**Недостатки:**
- Может очистить актуальные данные
- Дополнительная сложность

### 2. **Очистка по командам**

#### Идея: Привязка к команде
```javascript
{
  "team_122": {
    "5860450": "sp",
    "5865756": "brazil"
  },
  "team_12178": {
    "1234567": "norm",
    "7654321": "tiki"
  }
}
```

**Преимущества:**
- Изоляция данных команд
- Возможность очистки по команде
- Лучшая организация данных

**Недостатки:**
- Нужно определять ID команды
- Усложнение структуры

### 3. **Очистка по размеру (LRU)**

#### Идея: Least Recently Used
```javascript
{
  data: {
    "5860450": { style: "sp", lastUsed: 1706995200000 }
  },
  maxSize: 1000,
  currentSize: 245
}
```

**Преимущества:**
- Контроль размера кэша
- Сохранение часто используемых данных
- Автоматическая оптимизация

**Недостатки:**
- Сложность реализации
- Может удалить важные данные

### 4. **Очистка по сессиям**

#### Идея: Привязка к игровой сессии
```javascript
{
  sessionId: "match_58066_1706995200",
  data: {
    "5860450": "sp",
    "5865756": "brazil"
  },
  created: 1706995200000
}
```

**Преимущества:**
- Автоматическая очистка между матчами
- Изоляция данных сессий
- Простота понимания

**Недостатки:**
- Потеря данных между сессиями
- Нужно определять сессии

### 5. **Гибридный подход**

#### Идея: Комбинация стратегий
```javascript
{
  version: "1.0",
  lastCleanup: 1706995200000,
  teams: {
    "122": {
      players: {
        "5860450": {
          style: "sp",
          timestamp: 1706995200000,
          lastUsed: 1706995200000
        }
      },
      metadata: {
        created: 1706995200000,
        matchId: "58066"
      }
    }
  },
  settings: {
    maxAge: 86400000,      // 24 часа
    maxPlayersPerTeam: 50,
    maxTeams: 10
  }
}
```

## Рекомендуемая реализация

### Выбранная стратегия: **Гибридный подход**

Комбинация очистки по командам + TTL + ограничение размера

### Функции управления кэшем

#### 1. Очистка по времени
```javascript
function cleanExpiredStyles(maxAge = 24 * 60 * 60 * 1000) {
  // Удаляет записи старше maxAge
}
```

#### 2. Очистка по команде
```javascript
function clearTeamStyleCache(teamId) {
  // Очищает кэш для конкретной команды
}
```

#### 3. Полная очистка
```javascript
function clearAllStyleCache() {
  // Полная очистка всего кэша
}
```

#### 4. Умная очистка
```javascript
function smartCleanupStyleCache() {
  // Комбинированная очистка по всем критериям
}
```

#### 5. Статистика кэша
```javascript
function getStyleCacheStats() {
  // Возвращает статистику использования кэша
}
```

## Триггеры очистки

### Автоматические триггеры
1. **При загрузке страницы**: Очистка устаревших данных
2. **При смене команды**: Очистка данных предыдущей команды
3. **По расписанию**: Периодическая очистка (каждые 30 минут)
4. **При превышении лимита**: Очистка при достижении максимального размера

### Ручные триггеры
1. **Кнопка в UI**: Пользователь может очистить кэш
2. **Консольные команды**: Для разработчиков и продвинутых пользователей
3. **Настройки**: Опции в настройках системы

## UI элементы

### Индикатор кэша
```
[Кэш стилей: 45 игроков | Последняя очистка: 2 часа назад] [Очистить]
```

### Настройки кэша
```
☑ Автоматическая очистка (24 часа)
☑ Очистка при смене команды
☐ Агрессивная очистка (6 часов)
Максимум игроков: [100] [По умолчанию: 200]
```

## Логирование

### Теги логов
- `[CACHE]` - основные операции с кэшем
- `[CACHE_CLEANUP]` - операции очистки
- `[CACHE_STATS]` - статистика кэша

### Примеры логов
```
[CACHE] Загружен кэш: 45 игроков, 2 команды
[CACHE_CLEANUP] Очищено 12 устаревших записей (>24ч)
[CACHE_CLEANUP] Очищена команда 122: 8 игроков
[CACHE_STATS] Размер кэша: 2.3KB, hit rate: 87%
```

## Миграция данных

### Обратная совместимость
```javascript
function migrateOldCache(oldCache) {
  // Преобразует старый формат в новый
  // Сохраняет пользовательские настройки
}
```

### Версионирование
```javascript
const CACHE_VERSION = "1.0";
function validateCacheVersion(cache) {
  // Проверяет версию и мигрирует при необходимости
}
```

## Производительность

### Оптимизации
1. **Ленивая загрузка**: Загрузка кэша только при необходимости
2. **Батчинг**: Группировка операций записи
3. **Индексирование**: Быстрый поиск по командам и игрокам
4. **Сжатие**: Сжатие данных при сохранении

### Метрики
- Время загрузки кэша
- Размер кэша в памяти
- Hit/miss ratio
- Частота очистки

## Безопасность

### Валидация данных
```javascript
function validateStyleValue(style) {
  return CONFIG.STYLES.VALUES.hasOwnProperty(style);
}

function validatePlayerId(playerId) {
  return /^\d+$/.test(playerId);
}
```

### Защита от повреждения
```javascript
function safeCacheOperation(operation) {
  try {
    return operation();
  } catch (e) {
    console.error('[CACHE] Operation failed, restoring backup', e);
    restoreCacheBackup();
  }
}
```

## Тестирование

### Сценарии тестирования
1. **Нормальное использование**: Сохранение и загрузка стилей
2. **Очистка по времени**: Проверка TTL
3. **Очистка по команде**: Изоляция данных команд
4. **Переполнение**: Поведение при превышении лимитов
5. **Повреждение данных**: Восстановление после ошибок
6. **Миграция**: Обновление формата данных

### Автоматические тесты
```javascript
function testStyleCache() {
  // Набор автоматических тестов для кэша
}
```

---
*Дизайн создан: February 3, 2026*
*Версия: 1.0*