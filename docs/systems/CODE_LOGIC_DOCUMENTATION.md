# Документация логики работы Virtual Soccer Strength Analyzer

## Обзор архитектуры

Система состоит из нескольких основных компонентов, каждый из которых отвечает за определенную функциональность калькулятора силы команд.

## Конфигурация и константы

### Определение базового URL
Система автоматически определяет базовый URL в зависимости от текущего домена:
- `virtualsoccer.ru` (по умолчанию)
- `vfleague.com`
- `vfliga.com` 
- `vfliga.ru`

### Централизованный объект конфигурации
Содержит все основные настройки системы:
- Типы коллизий стилей игры
- Погодные условия и температурные карты
- Бонусы морали и домашнего поля
- Таблицы позиционных бонусов по стилям команды
- Модификаторы позиций игроков
- Конфигурация физических форм

### Позиционные бонусы
Система стилей команды с коэффициентами для каждой позиции:
- `bb` (бей-беги): бонусы для ST, CF, защитников
- `tiki` (тики-така): бонусы для полузащитников
- `brit` (британский): бонусы для фланговых игроков
- `sp` (спартаковский): бонусы для центральных позиций
- `kat` (катеначчо): бонусы для оборонительных позиций
- `brazil` (бразильский): бонусы для атакующих позиций

### Модификаторы позиций игроков
Штрафы и бонусы за игру не на родной позиции:
- Вратари: только на позиции GK
- Защитники: лучше всего на своих позициях, штрафы в атаке
- Полузащитники: универсальность с небольшими штрафами
- Нападающие: штрафы в обороне, бонусы в атаке

### Физические формы
Два типа турниров с разными диапазонами физических форм:
- Тип C (обычные турниры): 76%-124%
- Тип B (чемпионат, кубок межсезонья): 75%-125%
- Товарищеские матчи: фиксированные 100%
- Поддержка трендов (растет/падает)

## Система футболок

### Константы системы футболок
Определение координат позиций на поле и футболок по умолчанию.

### Генерация позиций на поле
Алгоритм размещения игроков:
1. Размеры контейнера с учетом отступов 34px со всех сторон
2. Определение зон по высоте для каждой команды (относительно контейнера)
3. Группировка позиций по линиям (вратарь, защита, полузащита, атака)
4. Функция распределения игроков по ширине поля
5. Размещение по линиям с учетом стороны команды

### TODO для системы футболок
- Разобраться с вертикальным размещением фланговых игроков
- Фланговые игроки не должны перемешиваться с центральными при переходе в другую линию

### Отладочная функция сетки
`window.debugFieldGrid()` для визуализации координат:
- Горизонтальные линии зон (относительно контейнера с отступами)
- Вертикальные линии (центр и края с отступами)
- Переключение видимости сетки

## Утилиты расчета бонусов

### Класс BonusCalculator
Статические методы для расчета различных бонусов:
- Домашний бонус в зависимости от процента поддержки
- Бонусы морали (супер/отдых)
- Позиционные бонусы по стилю игры
- Бонусы типа защиты (зональная/персональная)

## Управление глобальным состоянием

### Класс GameState
Управление состоянием игры:
- Хранение данных команд
- Управление погодными условиями
- Состояние интерфейса

### Класс StateManager
Сохранение и восстановление состояний:
- Сохранение всех состояний в localStorage
- Восстановление состояний при загрузке
- Управление кэшем данных

## Функции кэша футболок

### Система кэширования
- Генерация ключей кэша для команд
- Получение кэшированных футболок (действительны 7 дней)
- Сохранение футболок в кэш
- Обработка ошибок кэширования

## Фабрика UI компонентов

### Класс UIFactory
Создание переиспользуемых UI элементов:
- Селекты с опциями
- Кнопки с обработчиками
- Контейнеры с настройками
- Стилизованные элементы

## CSS стили

### Настройки команд
Стили для таблиц настроек команд с фиксированной шириной.

### Таблица составов
Фиксированные строки и выравнивание для таблиц составов.

### Псевдо-select2 для игроков
Кастомные селекты для выбора игроков с поиском.

### Мини-селектор позиции
Компактные селекты для выбора позиций игроков.

### Селектор стиля игрока
Кастомный селект для выбора стиля игры с визуальными индикаторами.

### Селектор физической формы
Селект для выбора физической формы с иконками состояния.

### Селектор капитана
Специальный селект для выбора капитана команды.

### Стили контейнера футболок
Позиционирование и отображение футболок на поле.

### Индикатор загрузки футболок
Анимация пульсации во время загрузки данных футболок.

## Функции данных футболок

### Получение последнего матча команды
Алгоритм поиска последнего сыгранного матча:
1. Загрузка страницы roster_m.php
2. Поиск ссылок на матчи
3. Проверка статуса матча (сыгран/не сыгран)
4. Возврат данных последнего валидного матча

### Извлечение данных матча
Парсинг страницы матча для получения футболок:
1. Определение статуса команды (дома/в гостях)
2. Поиск элементов футболок
3. Извлечение URL футболок из CSS
4. Возврат данных футболок

## Функции отображения футболок

### Создание элемента футболки
Генерация DOM элемента для отображения футболки игрока:
- Позиционирование на поле
- Применение изображения футболки
- Добавление текста позиции
- Стилизация элемента

### Отображение футболок на поле
Основная функция отображения:
1. Очистка предыдущих футболок
2. Создание контейнера
3. Генерация позиций для формаций
4. Создание и размещение элементов футболок
5. Обновление при изменении формации

## Обработка ошибок

### Стратегии обработки ошибок
- Игнорирование некритичных ошибок кэширования
- Перекачка данных при сетевых ошибках
- Использование значений по умолчанию при отсутствии данных
- Логирование ошибок для отладки

## Производительность

### Оптимизации
- Кэширование данных команд и футболок
- Параллельная загрузка данных
- Переиспользование DOM элементов
- Минимизация перерисовок интерфейса