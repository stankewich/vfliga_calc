# Граф связей позиций для Chemistry

**Дата**: 7 февраля 2026  
**Версия**: 0.946  
**Статус**: ✅ Реализовано

## Правила расчета Chemistry

### Базовый расчет
Chemistry рассчитывается на основе связей между игроками в составе:
- Каждая позиция имеет определенные связи с другими позициями
- За каждую связь с игроком, у которого совпадает стиль или национальность, начисляется бонус
- Максимальный бонус за одну связь: **12.5%**
- Чем больше связей, тем стабильнее Chemistry (меньше зависимость от одного игрока)

### Бонус/штраф за стиль команды (NEW v0.946)

Дополнительно к базовому расчету Chemistry, каждый игрок получает бонус или штраф в зависимости от соответствия его стиля стилю команды:

**Совпадение стилей:** +2.5%
- Если стиль игрока совпадает со стилем команды
- Пример: игрок со стилем "brazil" в команде со стилем "brazil"

**Коллизия стилей:** -2.5%
- Если стиль игрока находится в коллизии (win/lose) со стилем команды
- Пример: игрок со стилем "brazil" в команде со стилем "tiki" (brazil побеждает tiki)
- Или: игрок со стилем "tiki" в команде со стилем "brazil" (tiki проигрывает brazil)

**Нейтральные стили:** 0%
- Если стили не совпадают и не находятся в коллизии
- Если у игрока стиль "norm" (неизвестный стиль)

### Итоговая формула
```
Total Chemistry = Base Chemistry (от связей) + Team Style Bonus/Penalty
```

Пример:
- Игрок получил 9.4% от связей с другими игроками
- Стиль игрока "brazil" совпадает со стилем команды "brazil"
- Итоговый Chemistry: 9.4% + 2.5% = **11.9%**

## Обозначения позиций в коде

### Защитники (Defenders)
- **LD** - Левый защитник (Left Defender)
- **LB** - Левый атакующий защитник (Left Back)
- **CD** - Центральный защитник (Central Defender)
- **SW** - Подстраховщик (Sweeper)
- **RD** - Правый защитник (Right Defender)
- **RB** - Правый атакующий защитник (Right Back)

### Полузащитники (Midfielders)
- **LM** - Левый полузащитник (Left Midfielder)
- **LW** - Левый вингер (Left Winger)
- **CM** - Центральный полузащитник (Central Midfielder)
- **DM** - Опорный полузащитник (Defensive Midfielder)
- **AM** - Атакующий полузащитник (Attacking Midfielder)
- **FR** - Свободный хавбек (Free Roaming)
- **RM** - Правый полузащитник (Right Midfielder)
- **RW** - Правый вингер (Right Winger)

### Нападающие (Forwards)
- **CF** - Центральный нападающий (Central Forward)
- **ST** - Высокий нападающий (Striker)
- **LF** - Левый нападающий (Left Forward)
- **RF** - Правый нападающий (Right Forward)

## Граф связей GK (Вратарь)

### Правило из игры:
GK связан со **всеми защитниками** в составе.

### Примеры по схемам:

**Схема 4-4-2:** `GK - LD - CD - CD - RD`
```
        GK
    ┌───┼───┼───┐
   LD  CD  CD  RD
```
**Связи GK:** LD, CD, CD, RD (4 связи) - нет связи с RB LB!

**Схема 5-3-2:** `GK - LD - CD - CD - CD - RD`
```
        GK
   ──┼───┼───┼──
     CD  CD  CD  
```
**Связи GK:** CD, CD, CD (3 связи)

**Схема 3-5-2:** `GK - LD - CD - RD`
```
        GK
    ┌───┼───┐
   LD  CD  RD
```
**Связи GK:** LD, CD, RD (3 связи)

**С подстраховщиком:** `GK - LD - SW - CD - RD`
```
        GK
    ┌───┼───┐
   LD  SW  RD
```
**Связи GK:** LD, SW, RD (3 связи, если есть SW - связи с CD нет)

**С атакующими защитниками:** `GK - LB - SW - CD - RB`
```
        GK
    ┌───┼───┐
   LB  SW  RB
```
**Связи GK:** LB, SW, RB (3 связи, если CD = 1)

**С одним SW:** `GK - LB - SW - CD - CD - RB`
```
   GK
    ┼
   SW
```
**Связи GK:** SW (1 связь, если CD >1 и LD RD нет )

### Вывод:
GK связан с позициями: **LD, LB, CD, SW, RD, RB** (все защитники)

## Граф связей защитников

### LD (Левый защитник)

```
        GK (если CD count != 3)
         |
        LD ─────── CD (с мин индексом)
         |       
        LM | LW | LF

```

**Прямые связи:** GK, CD, (LM || LW || LF)

### LB 
```

```

**Прямые связи:** GK (если есть SW), CD (min index если CD >1), (LM || LW || LF)

### RB 
```

```

**Прямые связи:** GK (если есть SW), CD (max index если CD >1), (RM || RW || RF)

### RD (Правый защитник)

```
        GK (если CD count != 3)
         |
        RD ─────── CD(с макс индексом)
         |         
        RM | RW | RF
         
```

**Прямые связи:** GK, CD, (RM || RW || RF)

### CD (Центральный защитник со средним индексом)

```
        GK || SW
         |
    CD ─ CD ─ CD (если CD = 3 )
         |
         DM (if exist) || CM (1 line if CM = 1, 2 lines if CM = 2 with both CM)  || FR (if exist) || AM (if exist)


```

**Прямые связи:** (GK || SW ), CD (all), (DM || CM (all) || FR || AM)

### CD (Центральный защитник со минимальным индексом)

**Прямые связи:** (GK || SW ), CD (index+1), (LD || LB ), (DM || CM (min index) || FR || AM)

### CD (Центральный защитник со максимальным индексом)

**Прямые связи:** (GK || SW ), CD (index-1), (RD || RB ), (DM || CM (max index) || FR || AM)

### CD (Центральный защитник единственный в команде)

**Прямые связи:** (GK || SW ), (LD || LB ), (RD || RB ), (DM (all) || CM (all) || FR || AM)

### SW (Стоппер)

**Прямые связи:** GK , CD (all)

## Граф связей полузащитников

### LM (Левый полузащитник)

```
```

**Прямые связи:** (LD || LB ),  (CM (min index) || DM (min index)), (LF || CF (min index) || ST )

### CM (Центральный полузащитник со средним индексом (CM = 3))

```

```
**Прямые связи:** ( CD all ), CM (all), (CF (all) || ST)

### CM (Центральный полузащитник со min индексом (CM =< 3))

```

```
**Прямые связи:** (DM (all) || ( CD min index )), (LM || LW), CM (index+1), ((FR, AM) || (is424? (CF min index) : (LF || CF (min index) || ST)))

### CM (Центральный полузащитник со max индексом (CM =< 3))

```

```
**Прямые связи:** (DM (all) || ( CD max index )), (RM || RW), CM (index-1), ((FR, AM) || (is424? (CF max index) : (RF || CF (max index) || ST)))

### RM (Правый полузащитник)

```

```
**Прямые связи:** (RD || RB ),  (CM (max index) || DM (max index)), (RF || CF (max index) || ST )

### DM (Опорный полузащитник)

```

```

**Прямые связи:** CD (all), DM, (CM (all) || ((FR , AM) || ((CF all) || (LF, RF)))
|| (LM, LW, RM, RW))

### AM (Атакующий полузащитник)

```

```

**Прямые связи:** (CM (all) || DM (all)), FR, ((CF (all), RF, LF) || (ST, lf, rf))

### FR (Свободный художник)


**Прямые связи:** (CM (all) || DM (all)), AM, ((CF (all), RF, LF) || (ST, lf, rf))

## Граф связей нападающих

### LF (Левый нападающий)

```

```

**Прямые связи:** (LW || LM || LB || LD), 
(is424? ((ST & CF) || (CF min index)) : 
        ((CF || ST || (RF, ((AM || FR) || (CM (min index) || DM))))))

### RF (Правый нападающий)

```
```

**Прямые связи:** (RW || RM || RB || RD), 
(is424? ((ST & CF) || (CF max index)) : 
        ((CF || ST || (LF, ((AM || FR) || (CM (max index) || DM))))))

### CF (Центральный нападающий 3 > CF > 1)

**Прямые связи:** (LF || LW || LM ), (RF || RW || RM), CF, ST 
(is424? ((isST? (FR || CM all ) || (CF index min? LM : RM) : CM same index) || (FR || (CM same index)) : (AM || FR || CM same index || DM)))

### CF (Центральный нападающий CF = 3 min index)

**Прямые связи:** (LW || LM ), CF index+1, (AM || FR || CM min index || DM )

### CF (Центральный нападающий CF = 3 max index)

**Прямые связи:** (RW || RM ), CF index-1, (AM || FR || CM max index || DM )

### CF (Центральный нападающий CF = 3 !max_index && !min_index)

**Прямые связи:** CF all, (AM || FR || CM all || DM )


### ST || CF ( (ST + CF + RF + LF) = 1)

**Прямые связи:** (LW || LM ), (RW || RM), (AM || FR || CM all || DM)

### ST (Страйкер когда CF+ST=2)

**Прямые связи:** CF

### ST (Страйкер когда CF+ST=3)

**Прямые связи:** CF

### ST (is424)

**Прямые связи:** CF, LF, RF

### ST (ST+RF+LF=3) или CF (RF + CF + LF = 3)

**Прямые связи:** LF, RF, ((AM & FR) || (AM || FR || CM all || DM))

## Полная матрица связей

```
```

## Визуализация полного графа

```
```

## Особенности графа

### ⚠️ ВАЖНО: Chemistry бонусы и количество связей

**Максимальный Chemistry бонус всегда 12.5%** независимо от количества связей.

- 1 связь: Chemistry зависит от одной линии
- 4 связи: Chemistry усредняется по 4 линиям
- 5 связей: Chemistry усредняется по 5 линиям

**Формула расчета:**
```
BaseChemistry = (Σ LineModifiers) / ConnectionCount
FinalChemistry = BaseChemistry * StyleKnowledge
```

Где `LineModifier` может быть от -5% до +12.5% для каждой связи.

## Реализация в коде

### Функция получения связей

``

## Примеры использования

### Пример 1: Схема 4-4-2

**Состав:**
```
GK, LD, CD, CD, RD, LM, CM, CM, RM, CF, CF
```

**Связи GK:**
```javascript
getPositionConnections('GK', lineup)
// Результат: { direct: ['LD', 'CD', 'CD', 'RD'], diagonal: [] }
// 4 связи
```

**Связи CM (первый):**
```javascript
getPositionConnections('CM', lineup)
// Результат: { 
//   direct: ['CD', 'LM', 'RM', 'DM', 'AM', 'CF'],
//   diagonal: ['LD', 'RD', 'LW', 'RW', 'LF', 'RF']
// }
// В составе есть: CD, LM, RM, CF
// Активные прямые связи: 4
```

### Пример 2: Схема 5-3-2

**Состав:**
```
GK, LD, CD, CD, CD, RD, LM, CM, RM, CF, CF
```

**Связи GK:**
```javascript
getPositionConnections('GK', lineup)
// Результат: { direct: ['LD', 'CD', 'CD', 'CD', 'RD'], diagonal: [] }
// 5 связей!
```

## Следующие шаги

1. ✅ Определены все позиции в коде
2. ✅ Создан граф связей для всех позиций
3. ✅ Определена динамическая логика для GK
4. ⏳ Реализовать функцию `getPositionConnections()`
5. ⏳ Интегрировать с расчетом chemistry
6. ⏳ Тестирование на разных схемах
