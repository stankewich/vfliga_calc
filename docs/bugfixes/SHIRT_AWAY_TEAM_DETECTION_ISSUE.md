# Проблема: Футболки гостевой команды не обнаруживаются

## Дата: 2026-02-08

## Описание проблемы

При нажатии кнопки "Обновить футболки":
1. ✅ Кэш успешно очищается
2. ✅ Система перезагружается
3. ✅ Футболки домашней команды (home) загружаются корректно
4. ❌ Футболки гостевой команды (away) **НЕ находятся** и используются дефолтные

## Анализ лога

### Команда 122 (Home) - ✅ Работает

```
[SHIRTS] Trying selector: div.shirt.qf[id^="gif_0_"], found: 11
[SHIRTS] Processing 11 shirt divs
[SHIRTS] Found GK shirt: pics/shirts/sh_2_sm.png
[SHIRTS] Found field shirt: pics/shirts/sh_15825_sm.png
```

**Результат:** Успешно найдены футболки через DOMParser

### Команда 262 (Away) - ❌ Не работает

```
[SHIRTS] Trying selector: div.shirt.qf[id^="gif_1_"], found: 0
[SHIRTS] Trying selector: div.shirt[id^="gif_1_"], found: 0
[SHIRTS] Trying selector: div[id^="gif_1_"], found: 0
[SHIRTS] Found 0 div.shirt elements total
[SHIRTS] Found 43 div elements total
[SHIRTS] Found 2 table.tobl elements
[SHIRTS] Found 0 divs with 'gif' in id  ← КРИТИЧНО!
```

**Результат:** Используются дефолтные футболки

## Корневая причина

DOMParser **не находит элементы с `id^="gif_1_"`** в HTML странице `viewmatch.php`.

### Возможные причины:

1. **JavaScript генерирует элементы динамически**
   - Футболки гостевой команды добавляются после загрузки страницы через JS
   - DOMParser получает только статический HTML без выполнения JS
   - Элементы `gif_1_*` создаются клиентским скриптом

2. **HTML содержит только домашнюю команду**
   - Сервер отдает только `gif_0_*` элементы
   - Гостевая команда рендерится отдельно

3. **Проблема с определением isHome**
   - Неправильно определяется, какая команда дома/в гостях
   - Используется неправильный prefix

## Доказательства

Из лога видно:
- `Found 43 div elements total` - DOMParser видит div'ы
- `Found 2 table.tobl elements` - Таблицы с составом есть
- `Found 0 divs with 'gif' in id` - **НИ ОДНОГО** элемента с 'gif' в id!

Это означает, что **даже `gif_0_*` элементы не найдены** при поиске гостевой команды.

## Гипотеза

Страница `viewmatch.php` содержит футболки **только для одной команды** (той, которая указана первой в URL или в контексте). Для получения футболок другой команды нужно:
- Загружать страницу с другими параметрами
- Или использовать другой источник данных

## Решения

### Вариант 1: Использовать roster.php вместо viewmatch.php

Загружать футболки напрямую со страницы команды:
```javascript
// Вместо viewmatch.php?day=X&match_id=Y
// Использовать roster.php?num=teamId
```

**Плюсы:**
- Гарантированно есть футболки команды
- Не зависит от матчей
- Проще парсинг

**Минусы:**
- Нужно найти, где на странице команды отображаются футболки
- Может не быть футболок, если команда не играла

### Вариант 2: Загружать обе команды из разных матчей

Для каждой команды искать матч, где она играла **дома**:
```javascript
async function getTeamShirts(teamId) {
    // Найти матч, где команда играла ДОМА
    const homeMatch = await findHomeMatchForTeam(teamId);
    // Загрузить viewmatch.php для этого матча
    // Парсить gif_0_* (домашняя команда)
}
```

**Плюсы:**
- Используем существующую логику
- Всегда парсим gif_0_* (которые работают)

**Минусы:**
- Нужно искать домашний матч для каждой команды
- Больше запросов к серверу

### Вариант 3: Улучшить regex парсинг raw HTML

Проверить, есть ли футболки в raw HTML, но DOMParser их не видит:
```javascript
// Искать в response.responseText напрямую
const gifPattern = /id="gif_\d+_\d+"/g;
const allGifs = [...htmlText.matchAll(gifPattern)];
console.log('All gif elements in raw HTML:', allGifs);
```

**Плюсы:**
- Минимальные изменения
- Может сработать, если проблема в DOMParser

**Минусы:**
- Если футболок нет в HTML, не поможет

## Следующие шаги

1. **Добавить логирование** (✅ СДЕЛАНО):
   - Логировать определение isHome
   - Логировать prefix (gif_0_ или gif_1_)
   - Логировать поиск в raw HTML

2. **Проверить с новым логом**:
   - Правильно ли определяется isHome?
   - Есть ли gif_1_* в raw HTML?
   - Какие team IDs в матче?

3. **Выбрать решение** на основе результатов

## Временное решение

Пока проблема не решена, при обновлении футболок:
- ✅ Домашняя команда получает актуальные футболки
- ⚠️ Гостевая команда использует дефолтные футболки

Это не критично для функциональности, но визуально неправильно.

## Связанные файлы

- `calc.user.js` (lines 9600-9770): `getMatchLineup()` - парсинг футболок
- `calc.user.js` (lines 9775-9815): `getTeamShirts()` - основная функция
- `logs/console-export-2026-2-8_0-43-4.log`: Лог с проблемой

## Коммиты

- `a1a17a8`: Добавлено детальное логирование для отладки
- `1a01e8a`: Добавлено логирование кнопки обновления и кэша
