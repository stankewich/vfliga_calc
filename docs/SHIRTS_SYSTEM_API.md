# API системы отображения футболок

## Обзор

Система отображения футболок команд на поле калькулятора. Автоматически получает футболки из последних матчей команд и отображает их на поле в соответствии с формацией.

## Основные компоненты

### Константы позиций

#### `FIELD_POSITIONS`
Маппинг позиций игроков на координаты поля (566px высота, 200px ширина).

**Структура:**
```javascript
{
  home: { [position]: { top: number, left: number } },
  away: { [position]: { top: number, left: number } }
}
```

#### `DEFAULT_SHIRT` / `DEFAULT_GK_SHIRT`
Путь к футболкам по умолчанию: `'pics/shirts/sh_4_sm.png'`

### Функции кэширования

#### `getShirtsCacheKey(teamId)`
Генерирует ключ кэша для команды.

#### `getCachedShirts(teamId)`
Получает футболки из кэша (действительны 7 дней).

#### `setCachedShirts(teamId, shirts)`
Сохраняет футболки в кэш.

### Функции получения данных

#### `getLastMatchForTeam(teamId)`
Находит последний сыгранный матч команды.

**Алгоритм:**
1. Загружает `roster_m.php?num=${teamId}`
2. Ищет ссылки на матчи `a[href*="viewmatch.php"]`
3. Проверяет title на отсутствие "Матч ещё не сыгран"
4. Возвращает последний валидный матч

**Возвращает:**
```javascript
{ day: string, matchId: string } | null
```

#### `getMatchLineup(day, matchId, teamId)`
Извлекает футболки из конкретного матча.

**Алгоритм:**
1. Загружает страницу матча
2. Определяет статус команды (дома/в гостях)
3. Ищет элементы с классом `shirt.qf`
4. Извлекает URL футболок из CSS background-image

**Возвращает:**
```javascript
{ gk: string, field: string }
```

#### `getTeamShirts(teamId)`
Основная функция получения футболок команды.

**Логика:**
1. Проверяет кэш
2. Получает последний матч
3. Извлекает футболки из матча
4. Применяет значения по умолчанию
5. Сохраняет в кэш

### Функции отображения

#### `generateFieldPositions(formation, side)`
Генерирует координаты позиций для формации.

**Параметры:**
- `formation` (Array) - массив позиций
- `side` ('home'|'away') - сторона команды

**Алгоритм размещения:**
1. Группирует позиции по линиям (gk, def, semidef, mid, semiatt, att)
2. Рассчитывает горизонтальное распределение для каждой линии
3. Учитывает отступы 34px со всех сторон поля
4. Инвертирует порядок для гостевой команды

#### `createShirtElement(position, shirtUrl, side)`
Создает DOM элемент футболки.

**Стили элемента:**
- Размер: 30x30px
- Позиционирование: absolute
- Background: футболка команды
- Текст: позиция игрока

#### `displayShirtsOnField(fieldCol, homeShirts, awayShirts, homeFormation, awayFormation)`
Отображает все футболки на поле.

**Процесс:**
1. Очищает предыдущие футболки
2. Создает контейнер для футболок
3. Генерирует позиции для обеих команд
4. Создает и размещает элементы футболок

### Инициализация

#### `initializeShirtsSystem(homeTeamId, awayTeamId, fieldCol, homeFormationSelect, awayFormationSelect)`
Инициализирует систему футболок.

**Функциональность:**
- Загружает футболки для обеих команд параллельно
- Отображает футболки на поле
- Настраивает обработчики изменения формации

## Отладка

### `window.debugFieldGrid()`
Функция для визуализации сетки координат поля.

**Использование:**
```javascript
window.debugFieldGrid(); // показать сетку
window.debugFieldGrid(); // скрыть сетку
```

**Визуализация:**
- Красные линии: зоны размещения
- Синие линии: горизонтальное распределение
- Граница контейнера с отступами

## Обработка ошибок

Все функции включают обработку ошибок:
- Сетевые ошибки при загрузке данных
- Ошибки парсинга HTML
- Ошибки кэширования
- Fallback на значения по умолчанию

## Производительность

- Кэширование футболок на 7 дней
- Параллельная загрузка для обеих команд
- Переиспользование DOM элементов
- Оптимизированные CSS стили