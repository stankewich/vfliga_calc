# Анализ диапазона погодных условий

## Задача
Показывать расчет силы команд для граничных значений погоды и температуры.

## Пример
**Прогноз**: жарко, 22-30°

**Текущий расчет**: 
- Погода: жарко
- Температура: 22° (берется минимум)

**Требуется показать 3 варианта**:
1. **Минимум** (пессимистичный): 22° + солнечно (погода уровнем ниже)
2. **Средний** (текущий): 26° + жарко (средняя температура)
3. **Максимум** (оптимистичный): 30° + очень жарко (погода уровнем выше)

## Конфигурация погоды

### Шкала погоды (от жаркой к холодной)
```javascript
const WEATHER_SCALE = [
    "очень жарко",  // 0 - самая жаркая
    "жарко",        // 1
    "солнечно",     // 2
    "облачно",      // 3
    "пасмурно",     // 4
    "дождь",        // 5
    "снег"          // 6 - самая холодная
];
```

### Диапазоны температур для каждой погоды
```javascript
const WEATHER_TEMP_MAP = {
    "очень жарко": [30, 26],  // [max, min]
    "жарко": [29, 15],
    "солнечно": [29, 10],
    "облачно": [25, 5],
    "пасмурно": [20, 1],
    "дождь": [15, -5],
    "снег": [5, -15]
};
```

## Реализация

### ✅ Этап 1: Парсинг диапазона температур

Обновлена функция `parseWeatherFromPreview()` (строки 7848-7895):
- Добавлены поля `minTemp` и `maxTemp`
- Парсинг диапазона температур (например, "22-30")
- Сохранена обратная совместимость через поле `temperature`

```javascript
function parseWeatherFromPreview() {
    // ...
    if (tempMatch) {
        const tempStr = tempMatch[1].trim();
        if (tempStr.includes('-')) {
            const parts = tempStr.split('-');
            minTemp = parseInt(parts[0]);
            maxTemp = parseInt(parts[1]);
            temperature = minTemp; // для обратной совместимости
        } else {
            minTemp = maxTemp = parseInt(tempStr);
            temperature = minTemp;
        }
    }
    return {
        weather,
        temperature,
        minTemp,
        maxTemp,
        icon: weatherDiv.querySelector('img')?.src || ''
    };
}
```

### ✅ Этап 2: Логика вариантов погоды

Создана функция `getWeatherVariants()` (строки 7897-7920):
- Принимает текущую погоду и диапазон температур
- Возвращает 3 варианта: min, avg, max
- Для минимума: температура минимальная, погода на уровень холоднее
- Для среднего: температура средняя, погода текущая
- Для максимума: температура максимальная, погода на уровень жарче

```javascript
function getWeatherVariants(currentWeather, minTemp, maxTemp) {
    const WEATHER_SCALE = [
        "очень жарко", "жарко", "солнечно", 
        "облачно", "пасмурно", "дождь", "снег"
    ];
    
    const currentIndex = WEATHER_SCALE.indexOf(currentWeather);
    if (currentIndex === -1 || minTemp === null || maxTemp === null) {
        return null;
    }
    
    const avgTemp = Math.round((minTemp + maxTemp) / 2);
    
    return {
        min: {
            weather: WEATHER_SCALE[Math.min(currentIndex + 1, WEATHER_SCALE.length - 1)],
            temperature: minTemp,
            label: 'Минимум'
        },
        avg: {
            weather: currentWeather,
            temperature: avgTemp,
            label: 'Средний'
        },
        max: {
            weather: WEATHER_SCALE[Math.max(currentIndex - 1, 0)],
            temperature: maxTemp,
            label: 'Максимум'
        }
    };
}
```

### ✅ Этап 3: Обновление функции расчета

Обновлена функция `computeTeamStrength()` (строка 11463):
- Добавлены параметры `weatherOverride` и `temperatureOverride`
- Если параметры переданы, используются они вместо значений из UI
- Сохранена обратная совместимость (параметры опциональные)

```javascript
async function computeTeamStrength(lineup, players, teamStyleId, sideLabel, opponentTeamStyleId,
    homeBonusPercent = -1, userSynergy = 0, atmosphereValue = 0, 
    weatherOverride = null, temperatureOverride = null) {
    // ...
    const actualWeather = weatherOverride !== null ? weatherOverride : wt.weather;
    const actualTemperature = temperatureOverride !== null ? temperatureOverride : wt.temperature;
    // Используем actualWeather и actualTemperature в расчетах
}
```

### ✅ Этап 4: Извлечение эмблем команд

Обновлена функция `extractTeamNames()` (строки 10984-11010):
- Добавлено извлечение эмблем команд из заголовка матча
- Возвращает объект с полями: `home`, `away`, `homeEmblem`, `awayEmblem`

```javascript
function extractTeamNames() {
    const matchHeader = document.querySelector('tr[bgcolor="#006600"] td.txtw');
    if (matchHeader) {
        const teamLinks = matchHeader.querySelectorAll('a.mnuw');
        if (teamLinks.length >= 2) {
            const homeEmblem = teamLinks[0].querySelector('img')?.src || '';
            const awayEmblem = teamLinks[1].querySelector('img')?.src || '';
            const teamNames = matchHeader.querySelectorAll('a.mnuw b');
            
            return {
                home: teamNames[0]?.textContent.trim() || 'Команда хозяев',
                away: teamNames[1]?.textContent.trim() || 'Команда гостей',
                homeEmblem,
                awayEmblem
            };
        }
    }
    return {
        home: 'Команда хозяев',
        away: 'Команда гостей',
        homeEmblem: '',
        awayEmblem: ''
    };
}
```

### ✅ Этап 5: UI таблицы с вариантами

Обновлена функция `window.__vs_recalculateStrength` (строки 11875-12030):

#### Проверка пустых составов
- Проверяется наличие игроков в обоих составах
- Если составы пусты, показывается предупреждение в таблице (не alert!)
- Желтый фон (#fff9db) для предупреждения

#### Fallback для одного значения температуры
- Если нет диапазона температур, делается один расчет
- Показывается простой результат (как раньше)

#### Таблица с 3 вариантами
Структура таблицы:
1. **Заголовок** (зеленый фон #006600):
   - Эмблемы команд (если есть)
   - Названия команд
   
2. **Три строки данных**:
   - Минимум: минимальная температура + погода холоднее
   - Средний: средняя температура + текущая погода (желтый фон #fff9db)
   - Максимум: максимальная температура + погода жарче

Каждая строка содержит:
- Название варианта и погодные условия
- Сила хозяев с разницей и процентом
- Сила гостей с разницей и процентом

#### Обработка ошибок
- Ошибки показываются в таблице (не alert!)
- Красный фон (#ffe0e0) для ошибок
- Ссылка на консоль для деталей

## Примеры использования

### Пример 1: Жаркая погода с диапазоном
**Прогноз**: жарко, 22-30°

**Результат**:
```
┌─────────────────────────────────────────────────────────────┐
│ 🏠 Команда А — ✈️ Команда Б                                 │
├──────────────┬────────────────────┬────────────────────────┤
│ Минимум      │ Хозяева: 2698      │ Гости: 1730            │
│ солнечно,22° │ +968 (61%)         │ (39%)                  │
├──────────────┼────────────────────┼────────────────────────┤
│ Средний      │ Хозяева: 2715      │ Гости: 1745            │
│ жарко, 26°   │ +970 (61%)         │ (39%)                  │
├──────────────┼────────────────────┼────────────────────────┤
│ Максимум     │ Хозяева: 2732      │ Гости: 1760            │
│ очень жарко  │ +972 (61%)         │ (39%)                  │
│ 30°          │                    │                        │
└──────────────┴────────────────────┴────────────────────────┘
```

### Пример 2: Одна температура
**Прогноз**: облачно, 15°

**Результат**: Простой расчет (как раньше)
```
Сила хозяев: 2700
Сила гостей: 1735
```

### Пример 3: Пустые составы
**Результат**:
```
┌─────────────────────────────────────────────────────────────┐
│ ⚠️ Составы не заполнены                                     │
│ Добавьте игроков в составы обеих команд для расчета силы    │
└─────────────────────────────────────────────────────────────┘
```

## Производительность

### Количество расчетов
- **Без диапазона**: 1 расчет (2 команды) = 2 вызова `computeTeamStrength`
- **С диапазоном**: 3 расчета (2 команды каждый) = 6 вызовов `computeTeamStrength`

### Оптимизация
- Используется `Promise.all()` для параллельных расчетов
- Все 6 вызовов выполняются одновременно
- Время выполнения ≈ время одного расчета (не x6)

### Автоматический пересчет
Автоматический пересчет срабатывает при:
- Изменении игрока в составе
- Изменении стиля игры
- Изменении формации
- Изменении капитана
- Изменении сыгранности

**Важно**: С 3 вариантами это означает 6 расчетов вместо 2 при каждом изменении.

## Стилизация

### Цвета
- Заголовок: зеленый фон (#006600), белый текст
- Средний вариант: желтый фон (#fff9db) для выделения
- Предупреждение: желтый фон (#fff9db)
- Ошибка: красный фон (#ffe0e0)

### Классы сайта
Используются нативные классы для консистентности:
- `.lh18`, `.lh20` - высота строки
- `.txt` - обычный текст
- `.txtw` - белый текст
- `.rdl` - правая колонка (хозяева)
- `.gdl` - левая колонка (гости)
- `.lh12`, `.up` - маленький текст для разницы

### Адаптивность
- Таблица занимает 100% ширины контейнера
- Фиксированные размеры удалены для лучшей адаптивности
- Текст автоматически переносится при необходимости

## Обратная совместимость

### Сохранено
- Поле `temperature` в `parseWeatherFromPreview()`
- Старые вызовы `computeTeamStrength()` без новых параметров
- Простой расчет при отсутствии диапазона температур

### Изменено
- Добавлены новые поля `minTemp`, `maxTemp`
- Добавлены новые параметры `weatherOverride`, `temperatureOverride`
- Изменен UI результатов (таблица вместо простого текста)

## Известные ограничения

1. **Граничные случаи погоды**:
   - Для "очень жарко" максимум = текущая погода (нет жарче)
   - Для "снег" минимум = текущая погода (нет холоднее)

2. **Одинаковые температуры**:
   - Если minTemp = maxTemp, все 3 варианта будут с одной температурой
   - Но погода будет разная (холоднее/текущая/жарче)

3. **Отсутствие данных**:
   - Если нет информации о погоде, показывается ошибка
   - Если нет диапазона, показывается простой расчет

## Следующие шаги (опционально)

1. **Оптимизация автопересчета**:
   - Добавить настройку "Показывать варианты погоды"
   - При выключенной настройке делать простой расчет
   - Включать варианты только по кнопке

2. **Кэширование**:
   - Кэшировать результаты для одинаковых составов
   - Инвалидировать кэш при изменении состава

3. **Дополнительная информация**:
   - Показывать процентное изменение между вариантами
   - Добавить график изменения силы от температуры
   - Показывать, какие игроки больше всего зависят от погоды

4. **UI улучшения**:
   - Добавить иконки погоды (☀️, 🌤️, ☁️, 🌧️, ❄️)
   - Сделать таблицу сворачиваемой
   - Добавить экспорт результатов

## Статус

✅ **РЕАЛИЗОВАНО** (версия 0.945)

- Парсинг диапазона температур
- Генерация 3 вариантов погоды
- Параллельные расчеты для всех вариантов
- Таблица с результатами
- Извлечение эмблем команд
- Обработка пустых составов
- Обработка ошибок
- Fallback для одного значения температуры
