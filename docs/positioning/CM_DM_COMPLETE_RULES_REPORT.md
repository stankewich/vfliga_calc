# Полный набор правил CM→DM

## Новое правило
Добавлено правило: **если DM есть на поле, а CM + AM >= 2, то CM с минимальным индексом может стать DM**.

## Полная система правил CM→DM

### 1. Стандартные правила (базовая логика)
```javascript
if ((dmCount < 2) && cmCount > 2 && (rowIndex === cmMin1 || rowIndex === cmMin2)) cmToDMAllowed = true;
if ((dmCount < 2) && cmCount === 2 && rowIndex !== cmMax) cmToDMAllowed = true;
if ((dmCount < 2) && cmCount === 1) cmToDMAllowed = true;
```
- Работают когда DM < 2 (не более одного опорника)
- При CM > 2: разрешено первым двум CM
- При CM = 2: разрешено всем кроме последней CM
- При CM = 1: разрешено единственной CM

### 2. Правило дополнительного DM (новое)
```javascript
if (dmCount > 0 && centralMidfielders >= 2 && rowIndex === cmMin1) {
    cmToDMAllowed = true;
}
```
- Работает когда DM > 0 (уже есть опорник)
- Требует CM + AM >= 2 (достаточно центральных полузащитников)
- Разрешает только CM с минимальным индексом

### 3. Ограничение при CM = 2
```javascript
// Уже учтено в стандартных правилах
if ((dmCount < 2) && cmCount === 2 && rowIndex !== cmMax) cmToDMAllowed = true;
```
- CM с максимальным индексом не может стать DM при ровно 2 CM

### 4. Ограничение при недостатке полузащитников (высший приоритет)
```javascript
if (dmCount > 0 && centralMidfielders < 2 && rowIndex === cmMax) {
    cmToDMAllowed = false;
}
```
- Блокирует CM с максимальным индексом если DM > 0 и CM + AM < 2
- Имеет высший приоритет, отменяет все предыдущие разрешения

## Логика работы

### Порядок применения:
1. **Инициализация**: `cmToDMAllowed = false`
2. **Стандартные правила**: базовые разрешения при DM < 2
3. **Правило дополнительного DM**: дополнительные разрешения при DM > 0 и достаточном количестве полузащитников
4. **Ограничение недостатка**: блокировка при недостатке полузащитников (высший приоритет)

### Ключевые принципы:
- **Безопасность**: всегда сохраняем минимум полузащитников в центре
- **Гибкость**: при достатке полузащитников разрешаем дополнительные DM
- **Приоритеты**: ограничения имеют приоритет над разрешениями

## Примеры работы

### Пример 1: Дополнительный DM при достатке полузащитников
**Формация**: 4-1-2-3  
**Позиции**: `['GK', 'LD', 'CD', 'CD', 'RD', 'DM', 'CM', 'CM', 'AM', 'CF', 'ST']`
- DM = 1, CM = 2, AM = 1 → CM + AM = 3 >= 2 ✅
- **Первая CM (индекс 6)**: может стать DM ✅ (правило 3)
- **Вторая CM (индекс 7)**: НЕ может стать DM ❌ (ограничение CM=2)

### Пример 2: Блокировка при недостатке полузащитников
**Формация**: 4-1-3-2  
**Позиции**: `['GK', 'LD', 'CD', 'CD', 'RD', 'DM', 'CM', 'LW', 'RW', 'CF', 'CF']`
- DM = 1, CM = 1, AM = 0 → CM + AM = 1 < 2 ❌
- **CM (индекс 6)**: НЕ может стать DM ❌ (ограничение 2)

### Пример 3: Стандартные правила без DM
**Формация**: 4-3-3  
**Позиции**: `['GK', 'LD', 'CD', 'CD', 'RD', 'CM', 'CM', 'CM', 'AM', 'CF', 'ST']`
- DM = 0 → правила 3 и ограничение 2 не действуют
- **Первая CM**: может стать DM ✅ (стандартные правила: CM > 2)
- **Вторая CM**: может стать DM ✅ (стандартные правила: CM > 2)

### Пример 4: Комбинированное действие правил
**Формация**: 4-1-3-2  
**Позиции**: `['GK', 'LD', 'CD', 'CD', 'RD', 'DM', 'CM', 'CM', 'CM', 'CF', 'CF']`
- DM = 1, CM = 3, AM = 0 → CM + AM = 3 >= 2 ✅
- **Первая CM**: может стать DM ✅ (правило 3: дополнительный DM)
- **Вторая CM**: может стать DM ✅ (стандартные правила: CM > 2)
- **Третья CM**: может стать DM ✅ (стандартные правила: CM > 2)

## Внесенные изменения

### 1. Добавлено правило дополнительного DM (calc.user.js:3862-3866)
```javascript
// ПРАВИЛО 3: Если DM есть на поле, а CM + AM >= 2, то CM с минимальным индексом может быть DM
if (dmCount > 0 && centralMidfielders >= 2 && rowIndex === cmMin1) {
    cmToDMAllowed = true;
    console.log(`[PositionLogic] ✅ CM с мин индексом разрешен: DM=${dmCount}, CM+AM=${centralMidfielders}`);
}
```

### 2. Обновлено логирование (calc.user.js:3873-3878)
```javascript
console.log(`[PositionLogic] CM→DM проверка для позиции ${rowIndex}:`, {
    dmCount, cmCount, amCount, centralMidfielders, cmMin1, cmMax, 
    isMinCM: rowIndex === cmMin1, isMaxCM: rowIndex === cmMax,
    canBecomeDM: cmToDMAllowed
});
```

## Тестирование
Создан тест `test-cm-dm-complete-rules.html` для проверки всех сценариев:
- ✅ DM=1, CM+AM>=2 → CM с мин индексом может стать DM
- ✅ DM=1, CM+AM<2 → CM с макс индексом заблокирован
- ✅ DM=0 → стандартные правила
- ✅ Взаимодействие всех правил и ограничений

## Статус: ✅ РЕАЛИЗОВАНО
Правило "CM с минимальным индексом может стать DM если DM есть и CM+AM >= 2" успешно добавлено в систему правил `getAllowedMiniOptions`.