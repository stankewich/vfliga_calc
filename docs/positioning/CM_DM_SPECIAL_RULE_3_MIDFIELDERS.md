# Специальное правило CM → DM для схемы с 3 полузащитниками

## Статус: ✅ ЗАВЕРШЕНО

### Обзор

Добавлено специальное правило для CM → DM в схемах с 3 полузащитниками, когда максимальный полузащитник является FR.

## Новое правило

### **Условие:**
В схеме с **ровно 3 полузащитниками**, если полузащитник с **максимальным индексом** является **FR**, то **CM с максимальным индексом среди CM** разрешено стать **DM**.

### **Код реализации:**
```javascript
// НОВОЕ ПРАВИЛО: В схеме с 3 полузащитниками, если максимальный полузащитник - FR,
// то CM с максимальным индексом среди CM может стать DM
const totalMidfielders = midfielderIndices.length;
if (totalMidfielders === 3) {
    const maxMidfielderPos = positions[maxMidfielderIndex];
    if (maxMidfielderPos === 'FR' && rowIndex === cmMax) {
        console.log(`[PositionLogic] Специальное правило: 3 полузащитника, максимальный FR, CM с макс индексом может стать DM`);
        add(options, 'DM');
    }
}
```

## Логическое обоснование

### **Тактическая логика:**

#### **Проблема без правила:**
```javascript
["GK", "LD", "CD", "RD", "CM", "CM", "FR", "CF", "CF", "CF"]
//                      ↑CM(4) ↑CM(5) ↑FR(6) <- максимальный полузащитник

// Без специального правила:
// - CM(5) не может стать DM (не максимальный полузащитник)
// - FR(6) - максимальный, но это не CM
// - Результат: никто не может стать DM, хотя тактически это логично
```

#### **Решение с правилом:**
```javascript
// С новым правилом:
// - Всего полузащитников: 3 (CM, CM, FR)
// - Максимальный полузащитник: FR(6)
// - CM с максимальным индексом среди CM: CM(5)
// - Результат: CM(5) может стать DM по специальному правилу
```

### **Тактическое обоснование:**

#### **1. Роль FR:**
- **FR (Свободный художник)** - творческая позиция
- Не конфликтует с **DM (Опорный полузащитник)**
- FR играет выше по полю, DM - ниже

#### **2. Позиционная совместимость:**
```
Защита → DM → CM → FR → Атака
         ↑    ↑    ↑
      Опорник Центр Творец
```

#### **3. Тактическая гибкость:**
- Позволяет создать схему: **DM + CM + FR**
- Баланс: разрушение (DM) + контроль (CM) + творчество (FR)
- Реалистичная тактическая схема

## Примеры работы

### **✅ Правило СРАБАТЫВАЕТ:**

#### **Пример 1: Классическая ситуация**
```javascript
["GK", "LD", "CD", "RD", "CM", "CM", "FR", "CF", "CF", "CF"]
//                      ↑CM(4) ↑CM(5) ↑FR(6)

// Условия:
// - totalMidfielders = 3 ✅
// - maxMidfielderPos = 'FR' ✅  
// - rowIndex === cmMax (5) ✅
// РЕЗУЛЬТАТ: CM(5) может стать DM
```

#### **Пример 2: С DM в составе**
```javascript
["GK", "LD", "CD", "RD", "DM", "CM", "FR", "CF", "CF", "CF"]
//                      ↑DM(4) ↑CM(5) ↑FR(6)

// Условия:
// - totalMidfielders = 3 ✅
// - maxMidfielderPos = 'FR' ✅
// - rowIndex === cmMax (5) ✅ (единственный CM)
// РЕЗУЛЬТАТ: CM(5) может стать DM (будет 2 DM)
```

### **❌ Правило НЕ СРАБАТЫВАЕТ:**

#### **Пример 3: Не 3 полузащитника**
```javascript
["GK", "LD", "CD", "RD", "CM", "CM", "RM", "CF", "CF", "CF"]
//                      ↑CM(4) ↑CM(5)

// totalMidfielders = 2 ❌
// РЕЗУЛЬТАТ: Правило не применяется
```

#### **Пример 4: Максимальный не FR**
```javascript
["GK", "LD", "CD", "RD", "FR", "CM", "CM", "CF", "CF", "CF"]
//                      ↑FR(4) ↑CM(5) ↑CM(6)

// maxMidfielderPos = 'CM' ❌ (не FR)
// РЕЗУЛЬТАТ: Правило не применяется
```

#### **Пример 5: Не максимальный CM**
```javascript
["GK", "LD", "CD", "RD", "CM", "CM", "FR", "CF", "CF", "CF"]
//                      ↑CM(4) ↑CM(5) ↑FR(6)

// Для CM(4): rowIndex !== cmMax ❌
// РЕЗУЛЬТАТ: CM(4) не может стать DM по этому правилу
```

## Интеграция с существующей логикой

### **Приоритет правил:**
1. **Основные правила CM → DM** (проверяются первыми)
2. **Специальное правило** (проверяется дополнительно)

### **Не конфликтует с:**
- ✅ Существующей логикой CM → DM
- ✅ Логикой CM → AM  
- ✅ Логикой CM → FR
- ✅ Формацией 4-2-4
- ✅ Формацией 3-6-1

### **Дополняет логику:**
```javascript
// Сначала основные правила
if (cmToDMAllowed) add(options, 'DM');

// Затем специальное правило (может добавить DM дополнительно)
if (totalMidfielders === 3 && maxMidfielderPos === 'FR' && rowIndex === cmMax) {
    add(options, 'DM'); // Не дублируется благодаря проверке в add()
}
```

## Технические детали

### **Место в коде:**
- **Файл:** `calc.user.js`
- **Функция:** `getAllowedMiniOptions()`
- **Секция:** `case 'CM'`
- **Строка:** После основной логики CM → DM

### **Переменные:**
- `midfielderIndices` - индексы всех полузащитников
- `totalMidfielders` - количество полузащитников
- `maxMidfielderIndex` - максимальный индекс полузащитника
- `maxMidfielderPos` - позиция максимального полузащитника
- `cmMax` - максимальный индекс среди CM

### **Логирование:**
```javascript
console.log(`[PositionLogic] Специальное правило: 3 полузащитника, максимальный FR, CM с макс индексом может стать DM`);
```

## Тестовые сценарии

### **Основные случаи:**
- [ ] 3 полузащитника: CM, CM, FR → CM может стать DM
- [ ] 3 полузащитника: DM, CM, FR → CM может стать DM  
- [ ] 3 полузащитника: CM, DM, FR → DM не затронут

### **Граничные случаи:**
- [ ] 2 полузащитника: правило не срабатывает
- [ ] 4 полузащитника: правило не срабатывает
- [ ] Максимальный не FR: правило не срабатывает
- [ ] Не максимальный CM: правило не срабатывает

### **Совместимость:**
- [ ] Работа с основными правилами CM → DM
- [ ] Работа с формацией 4-2-4
- [ ] Работа с формацией 3-6-1
- [ ] Работа с другими позициями (AM, FR)

## Заключение

**Специальное правило успешно добавлено и расширяет тактические возможности.**

### **Преимущества:**
✅ **Тактическая гибкость:** Позволяет создать схему DM + CM + FR  
✅ **Логическая обоснованность:** FR не конфликтует с DM  
✅ **Дополнительность:** Не нарушает существующую логику  
✅ **Специфичность:** Срабатывает только в конкретной ситуации  

### **Результат:**
Пользователи получают больше тактических возможностей при работе с полузащитой, особенно при использовании свободного художника (FR).

**Дата реализации:** 6 января 2026  
**Версия:** v0.926  
**Статус:** Готово к использованию